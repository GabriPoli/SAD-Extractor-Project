<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Indicadores - Extra√ß√£o de Laudos</title>
    <link rel="stylesheet" href="IndicadoresSAD.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Incluir auth.js -->
    <script src="../../js/auth.js"></script>
</head>
<body>
    <header class="main-header">
        <div class="header-top container-full">
            <div class="header-brand">
                <div class="logo-box">
                    <svg class="icon-doc" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <div class="brand-text">
                        <h1>SAD Extractor</h1>
                        <span>Sistema de Extra√ß√£o de dados imobili√°rios</span>
                    </div>
                </div>
            </div>
            <div class="header-logos">
                <img src="/images/logoSADGovPE.png" alt="Governo de Pernambuco" class="gov-logo"> 
            </div>
        </div>

        <div class="header-nav container-full">
            <nav class="nav-links">
                <a href="../Upload/upload.html">Upload de documentos</a>
                <span class="divider">|</span>
                <a href="../../Edicao/edicao.html">Editar dados</a>
                <span class="divider">|</span>
                <a href="../../Historico_Laudos/TelaHistoricoLaudos.html">Hist√≥rico de Laudos</a>
                <span class="divider">|</span>
                <a href="../Historico_Usuarios/historico_usuarios.html">Hist√≥rico de usu√°rios</a>
                <span class="divider">|</span>
                <a href="IndicadoresSAD.html" class="active">Indicadores</a>
                <span class="divider">|</span>
                <a href="../Gerenciamento_Usu√°rios/TelaGerenciamento.html">Configura√ß√µes</a>
            </nav>
            <div class="user-info" id="userInfo">
                <span>Ol√°, <strong id="userName">Carregando...</strong></span>
                <div class="avatar" id="userAvatar">TT</div>
                <span class="dropdown-arrow">‚ñº</span>
                <!-- Menu dropdown para logout -->
                <div class="dropdown-menu" id="dropdownMenu" style="display: none;">
                    <a href="#" id="logoutLink">Sair</a>
                </div>
            </div>
        </div>
    </header>
    <div class="dashboard-container">
        <header>
            <h1>Painel de Indicadores</h1>
            <p>Principais m√©tricas e acompanhamentos sobre os dados de Extra√ß√£o de Laudos</p>
        </header>

        <div class="indicator-cards">
            <div class="card">
                <div class="card-header">
                    <h2>Total Extra√≠do</h2>
                    <i class="fas fa-info-circle"></i>
                </div>
                <p class="main-value" id="total-extracted-value">126.560</p>
                <div class="sub-data">
                    <p class="change-info">
                        <span class="positive">M√™s a M√™s üîº 12%</span> | Laudos por Dia: 8.846
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>M√©dia Di√°ria</h2>
                    <i class="fas fa-info-circle"></i>
                </div>
                <p class="main-value" id="daily-average-value">8.846</p>
                <div class="sub-data">
                    <p class="small-text">Varia√ß√£o Semanal:</p>
                    <canvas id="daily-avg-chart-mini"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Confiabilidade M√©dia</h2>
                    <i class="fas fa-info-circle"></i>
                </div>
                <p class="main-value" id="reliability-value">95,60%</p>
                <div class="sub-data">
                    <p class="change-info">
                        <span class="negative">M√™s a M√™s üîΩ 5%</span> | Taxa de Convers√£o: 90%
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Extra√ß√£o Eficiente</h2>
                    <i class="fas fa-info-circle"></i>
                </div>
                <p class="main-value" id="efficiency-value">78%</p>
                <div class="sub-data">
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: 78%;"></div>
                    </div>
                    <p class="change-info">
                        <span class="positive">M√™s a M√™s üîº 12%</span> | M√™s Anterior: 66%
                    </p>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="chart-section">
                <div class="tabs">
                    <button class="tab-button active">Extra√ß√µes</button>
                    <button class="tab-button">Confiabilidade</button>
                </div>

                <div class="time-filters">
                    <button class="filter-button active" data-period="day">Di√°rio</button>
                    <button class="filter-button" data-period="week">Semanal</button>
                    <button class="filter-button" data-period="month">Mensal</button>
                    <button class="filter-button" data-period="year">Anual</button>
                    <input type="date" value="2024-01-01">
                    <span>-</span>
                    <input type="date" value="2024-12-31">
                </div>

                <h3>Tend√™ncia de Extra√ß√£o de Laudos</h3>
                <div class="chart-container">
                    <canvas id="extraction-trend-chart"></canvas>
                </div>
            </div>

            <div class="ranking-section">
                <h3>Ranking de Confiabilidade</h3>
                <ul id="reliability-ranking">
                    </ul>
            </div>
        </div>
    </div>

    <!-- Script de autentica√ß√£o -->
    <script>
        // Verificar autentica√ß√£o ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // 1. Verifica se o usu√°rio est√° logado
            if (!auth.estaLogado()) {
                alert('Voc√™ precisa fazer login para acessar esta p√°gina.');
                window.location.href = '../../../Tela_de_Login/telaLogin.html';
                return;
            }

            // 2. Verifica permiss√£o para esta p√°gina espec√≠fica
            if (!auth.podeAcessarPagina('IndicadoresSAD.html')) {
                alert('Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.');
                // Redireciona para uma p√°gina que o usu√°rio tem acesso
                window.location.href = '../Dashboard_Cadastro/Upload/upload.html';
                return;
            }

            // 3. Atualizar informa√ß√µes do usu√°rio na interface
            document.getElementById('userName').textContent = auth.getNomeUsuario();
            
            // Configurar avatar com iniciais
            const avatar = document.getElementById('userAvatar');
            const nome = auth.getNomeUsuario();
            const iniciais = nome.split(' ').map(n => n[0]).join('').toUpperCase();
            avatar.textContent = iniciais.substring(0, 2);

            // 4. Configurar menu dropdown
            const userInfo = document.getElementById('userInfo');
            const dropdownMenu = document.getElementById('dropdownMenu');
            const logoutLink = document.getElementById('logoutLink');

            userInfo.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdownMenu.style.display = dropdownMenu.style.display === 'none' ? 'block' : 'none';
            });

            logoutLink.addEventListener('click', function(e) {
                e.preventDefault();
                sessionStorage.removeItem('usuarioLogado');
                
                // Caminho FIXO para todas as p√°ginas
                // Ajuste conforme necess√°rio:
                window.location.href = '../Tela_de_Login/telaLogin.html';
            });

            // Fechar dropdown ao clicar fora
            document.addEventListener('click', function() {
                dropdownMenu.style.display = 'none';
            });

            // 5. Esconder links que o usu√°rio n√£o tem permiss√£o
            const linksParaEsconder = {
                'historico_usuarios': document.querySelector('a[href*="historico_usuarios"]'),
                'indicadores': document.querySelector('a[href*="IndicadoresSAD"]'),
                'configuracoes': document.querySelector('a[href*="TelaGerenciamento"]')
            };

            for (const [permissao, elemento] of Object.entries(linksParaEsconder)) {
                if (elemento && !auth.temPermissao(permissao)) {
                    elemento.style.display = 'none';
                    // Esconder o divisor anterior se existir
                    const divisorAnterior = elemento.previousElementSibling;
                    if (divisorAnterior && divisorAnterior.classList.contains('divider')) {
                        divisorAnterior.style.display = 'none';
                    }
                }
            }
        });
    </script>

    <script src="IndicadoresSAD.js"></script>
</body>
</html>